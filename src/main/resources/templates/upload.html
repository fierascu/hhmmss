<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      th:replace="~{${theme == 'classic' ? 'layout-classic' : (theme == 'terminal' ? 'layout' : 'layout-ascii')} :: layout(title='Upload Timesheet', content=~{::content})}">

<th:block th:fragment="content">
    <!-- Upload Form -->
    <form th:action="${theme == 'classic' ? '/?theme=classic' : (theme == 'terminal' ? '/?theme=terminal' : '/')}"
          enctype="multipart/form-data" method="POST">
        <div class="form-group">
            <label for="fileInput">Select Excel Timesheet or ZIP file</label>
            <input id="fileInput" name="file" type="file"
                   accept=".xls,.xlsx,.xlsm,.xlsb,.zip"/>
        </div>
        <button id="uploadButton" type="submit" class="btn btn-primary" disabled>
            Upload and Convert
        </button>
    </form>

    <script>
        document.getElementById('fileInput').addEventListener('change', function() {
            var uploadButton = document.getElementById('uploadButton');
            var file = this.files[0];

            if (!file) {
                uploadButton.disabled = true;
                return;
            }

            // Check if the file has an Excel or ZIP extension
            var fileName = file.name.toLowerCase();
            var isValidFile = fileName.endsWith('.xls') ||
                             fileName.endsWith('.xlsx') ||
                             fileName.endsWith('.xlsm') ||
                             fileName.endsWith('.xlsb') ||
                             fileName.endsWith('.zip');

            uploadButton.disabled = !isValidFile;
        });

        // Add loading animation on form submit
        document.querySelector('form').addEventListener('submit', function() {
            var uploadButton = document.getElementById('uploadButton');
            uploadButton.disabled = true;

            // ASCII spinner frames
            var spinnerFrames = ['|', '/', '-', '\\'];
            var currentFrame = 0;

            // Update button text with spinner animation
            var spinnerInterval = setInterval(function() {
                uploadButton.textContent = 'Processing ' + spinnerFrames[currentFrame];
                currentFrame = (currentFrame + 1) % spinnerFrames.length;
            }, 150); // Update every 150ms

            // Store interval ID so it can be cleared if needed
            uploadButton.dataset.spinnerInterval = spinnerInterval;
        });
    </script>

    <!-- Error Message -->
    <div th:if="${errorMessage}" class="alert alert-error" style="margin-top: 1rem;">
        <strong>[ERROR]</strong>
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- Success Message -->
    <div th:if="${successMessage}" class="alert alert-success" style="margin-top: 1rem;">
        <span th:text="${successMessage}"></span>

        <!-- Show processed files list for ZIP batch processing -->
        <div th:if="${isZipResult}" style="margin-top: 1rem;">
            <div th:if="${processedFiles != null and !#lists.isEmpty(processedFiles)}" style="margin-top: 0.75rem;">
                <strong style="color: #065f46;">Successfully processed files:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.25rem; color: #065f46;">
                    <li th:each="file : ${processedFiles}" th:text="${file}"></li>
                </ul>
            </div>

            <div th:if="${failedFiles != null and !#lists.isEmpty(failedFiles)}" style="margin-top: 0.75rem;">
                <strong style="color: #991b1b;">Failed files:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.25rem; color: #991b1b;">
                    <li th:each="file : ${failedFiles}" th:text="${file}"></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Generated Files from Current Conversion -->
    <div th:if="${generatedFiles != null and !#lists.isEmpty(generatedFiles)}" class="file-list">
        <h3>Generated Files</h3>
        <ul>
            <li th:each="file, iterStat : ${generatedFiles}">
                <a th:href="${generatedFileUrls[iterStat.index]}" th:text="${file}"></a>
            </li>
        </ul>
    </div>

    <!-- Template Download Section -->
    <div class="template-download" style="margin-top: 2rem; padding: 1rem; border: 1px solid; border-radius: 4px;">
        <h3 style="margin-top: 0;">Download Template</h3>
        <p>Need a timesheet template? Download our sample Excel file to get started.</p>
        <a href="/timesheet-in.xlsx" download class="btn btn-secondary" style="display: inline-block; margin-top: 0.5rem;">
            Download timesheet-in.xlsx
        </a>

        <form id="customTemplateForm" th:action="@{/template/generate}" method="GET" style="margin-top: 1.5rem;">
            <div class="form-group">
                <label for="monthSelector">Month</label>
                <select id="monthSelector" name="month" class="form-control" style="max-width: 200px;">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label for="yearSelector">Year</label>
                <select id="yearSelector" name="year" class="form-control" style="max-width: 200px;">
                    <!-- Years will be populated by JavaScript -->
                </select>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">
                Generate Custom Template
            </button>
        </form>
    </div>

    <script>
        // Set current month and year as defaults
        (function() {
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();

            // Set current month
            document.getElementById('monthSelector').value = currentMonth;

            // Populate year selector with range from 5 years ago to 2 years in the future
            var yearSelector = document.getElementById('yearSelector');
            for (var year = currentYear - 5; year <= currentYear + 2; year++) {
                var option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelector.appendChild(option);
            }
        })();
    </script>
</th:block>

</html>
