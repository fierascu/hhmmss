<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      th:replace="~{${theme == 'classic' ? 'layout-classic' : (theme == 'terminal' ? 'layout' : 'layout-ascii')} :: layout(title='Upload Timesheet', content=~{::content})}">

<th:block th:fragment="content">
    <!-- Upload and Convert Form -->
    <form th:action="${theme == 'classic' ? '/?theme=classic' : (theme == 'terminal' ? '/?theme=terminal' : '/')}"
          enctype="multipart/form-data" method="POST">
        <div class="form-group">
            <label for="fileInput">Upload and Convert (as-is)</label>
            <div style="display: flex; gap: 1rem; align-items: flex-start; margin-top: 0.5rem;">
                <div style="flex: 1;">
                    <input id="fileInput" name="file" type="file"
                           accept=".xls,.xlsx,.xlsm,.xlsb,.zip"
                           style="width: 100%;"/>
                </div>
                <button id="uploadButton" type="submit" class="btn btn-primary" disabled style="white-space: nowrap;">
                    Convert
                </button>
            </div>
        </div>
    </form>

    <!-- Generate New Timesheet Form -->
    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #444;">
        <form th:action="${theme == 'classic' ? '/generate?theme=classic' : (theme == 'terminal' ? '/generate?theme=terminal' : '/generate')}"
              method="POST">
            <div class="form-group">
                <label for="monthInput">Generate New Timesheet</label>
                <div style="display: flex; gap: 1rem; align-items: flex-start; margin-top: 0.5rem;">
                    <div style="flex: 1;">
                        <input id="monthInput" name="period" type="month" required
                               placeholder="YYYY-MM"
                               style="width: 100%; padding: 0.5rem; font-family: monospace;"/>
                        <small style="display: block; margin-top: 0.25rem; opacity: 0.7;">
                            Select period to generate a new timesheet from template
                        </small>
                    </div>
                    <button id="generateButton" type="submit" class="btn btn-primary" style="white-space: nowrap;">
                        Generate Timesheet
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Upload and Convert form
        document.getElementById('fileInput').addEventListener('change', function() {
            var uploadButton = document.getElementById('uploadButton');
            var file = this.files[0];

            if (!file) {
                uploadButton.disabled = true;
                return;
            }

            // Check if the file has an Excel or ZIP extension
            var fileName = file.name.toLowerCase();
            var isValidFile = fileName.endsWith('.xls') ||
                             fileName.endsWith('.xlsx') ||
                             fileName.endsWith('.xlsm') ||
                             fileName.endsWith('.xlsb') ||
                             fileName.endsWith('.zip');

            uploadButton.disabled = !isValidFile;
        });

        // Pre-populate month input with current month and year
        (function() {
            var monthInput = document.getElementById('monthInput');
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            monthInput.value = year + '-' + month;
        })();

        // Add loading animation on form submit for both forms
        document.querySelectorAll('form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                var button = form.querySelector('button[type="submit"]');
                button.disabled = true;

                // ASCII spinner frames
                var spinnerFrames = ['|', '/', '-', '\\'];
                var currentFrame = 0;

                // Update button text with spinner animation
                var spinnerInterval = setInterval(function() {
                    button.textContent = 'Processing ' + spinnerFrames[currentFrame];
                    currentFrame = (currentFrame + 1) % spinnerFrames.length;
                }, 150); // Update every 150ms

                // Store interval ID so it can be cleared if needed
                button.dataset.spinnerInterval = spinnerInterval;
            });
        });
    </script>

    <!-- Error Message -->
    <div th:if="${errorMessage}" class="alert alert-error" style="margin-top: 1rem;">
        <strong>[ERROR]</strong>
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- Success Message -->
    <div th:if="${successMessage}" class="alert alert-success" style="margin-top: 1rem;">
        <span th:text="${successMessage}"></span>

        <!-- Show processed files list for ZIP batch processing -->
        <div th:if="${isZipResult}" style="margin-top: 1rem;">
            <div th:if="${processedFiles != null and !#lists.isEmpty(processedFiles)}" style="margin-top: 0.75rem;">
                <strong style="color: #065f46;">Successfully processed files:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.25rem; color: #065f46;">
                    <li th:each="file : ${processedFiles}" th:text="${file}"></li>
                </ul>
            </div>

            <div th:if="${failedFiles != null and !#lists.isEmpty(failedFiles)}" style="margin-top: 0.75rem;">
                <strong style="color: #991b1b;">Failed files:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.25rem; color: #991b1b;">
                    <li th:each="file : ${failedFiles}" th:text="${file}"></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Generated Files from Current Conversion -->
    <div th:if="${generatedFiles != null and !#lists.isEmpty(generatedFiles)}" class="file-list">
        <h3>Generated Files</h3>
        <ul>
            <li th:each="file, iterStat : ${generatedFiles}">
                <a th:href="${generatedFileUrls[iterStat.index]}" th:text="${file}"></a>
            </li>
        </ul>
    </div>
</th:block>

</html>
